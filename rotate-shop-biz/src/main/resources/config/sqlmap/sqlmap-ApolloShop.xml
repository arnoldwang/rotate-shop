<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">


<!--Create by daogen http://code.dianpingoa.com/yihua.huang/daogen/-->
<!--@author yihua.huang@dianping.com-->
<sqlMap namespace="ApolloShop">

    <resultMap id="apolloShop" class="com.dianping.rotate.shop.entity.ApolloShopEntity">
        <result column="ID" property="id"/>
        <result column="ShopID" property="shopID"/>
        <result column="ShopStatus" property="shopStatus"/>
        <result column="ShopGroupID" property="shopGroupID"/>
        <result column="CityID" property="cityID"/>
        <result column="District" property="district"/>
        <result column="ShopType" property="shopType"/>
        <result column="Status" property="status"/>
    </resultMap>

    <resultMap id="apolloShopDto" class="com.dianping.rotate.shop.dto.ApolloShopDTO">
        <result column="ShopID" property="shopID"/>
        <result column="ShopGroupID" property="shopGroupID"/>
        <result column="CityID" property="cityID"/>
        <result column="District" property="district"/>
        <result column="ShopType" property="shopType"/>
        <result column="Status" property="shopStatus"/>
        <result column="Type" property="type"/>
        <result column="BizID" property="bizID"/>
        <result column="ShopExtendStatus" property="shopExtendStatus"/>
    </resultMap>

    <sql id="keys">
        ShopID,
        ShopStatus,
        ShopGroupID,
        CityID,
        District,
        ShopType,
        Status
    </sql>




    <!-- 直接返回dto的select语句 -->
    <sql id="queryDtoSelect">
      SELECT m.ShopID,
             m.ShopGroupID,
             m.CityID,
             m.District,
             m.ShopType,
             m.Status,
             ex.Type,
             ex.BizID,
             ex.Rating,
             ex.Status as ShopExtendStatus
        FROM ApolloShop m
      left join ApolloShopExtend ex on m.ShopID = ex.ShopID
    </sql>


    <select id="queryApolloShopByShopID" resultMap="apolloShop" parameterClass="map">
        SELECT
        ID,
        <include refid="keys"/>
        FROM ApolloShop
        WHERE ShopID = #shopID# and Status != 0
    </select>

    <insert id="addApolloShop" parameterClass="map">
        INSERT INTO ApolloShop
        (
        <include refid="keys"/>
        )
        values
        (
        #apolloShop.shopID#,
        #apolloShop.shopStatus#,
        #apolloShop.shopGroupID#,
        #apolloShop.cityID#,
        #apolloShop.district#,
        #apolloShop.shopType#,
        #apolloShop.status#
        )
        <selectKey resultClass="int" keyProperty="id">
            SELECT @@IDENTITY AS ID
        </selectKey>
    </insert>

    <update id="deleteApolloShopByShopID" parameterClass="map">
        update ApolloShop
        set
        Status = 0,
        LastModifiedTime = NOW()
        WHERE ShopID = #shopID#
    </update>

    <update id="updateApolloShop" parameterClass="map">
        update ApolloShop
        set
        ShopGroupID = #apolloShop.shopGroupID#,
        CityID = #apolloShop.cityID#,
        ShopStatus = #apolloShop.shopStatus#,
        District = #apolloShop.district#,
        ShopType = #apolloShop.shopType#,
        Status = #apolloShop.status#,
        LastModifiedTime = NOW()
        WHERE ShopID = #apolloShop.shopID#
    </update>


    <!-- 提供给战区分页查询门店信息，并返回DTO -->
    <select id="queryApolloShopsForTerritory" resultMap="apolloShopDto" parameterClass="map">
        <include refid="queryDtoSelect" />
        where ex.bizID = #bizID#
        <![CDATA[
            and m.ID % #modKey# = #modValue#
        ]]>
        <isNotEqual prepend="AND" property="ruleExpression" compareValue="0">
            #ruleExpression#
        </isNotEqual>
        order by m.ID;
    </select>
    <select id="queryApolloShopsForTerritory_COUNT" resultClass="int" parameterClass="map">
        <![CDATA[
            select count(1)
            from (
               select count(1)
                 from ApolloShop m
            left join ApolloShopExtend ex on m.ShopID = ex.ShopID
                where ex.bizID = #bizID# and m.ID % #modKey# = #modValue#
        ]]>
        <isNotEqual prepend="AND" property="ruleExpression" compareValue="0">
            #ruleExpression#
        </isNotEqual>
        <![CDATA[
            order by m.ID ) as mr;
         ]]>
    </select>

</sqlMap>